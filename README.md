# Meta-Sync

A CLI tool to sync metafield and metaobject definitions between Shopify stores, perfect for managing staging â†’ production deployments.

## Features

- âœ… **List** all metafield/metaobject definitions from any store
- âœ… **Copy** selective definitions between stores using manifest files
- âœ… **Bulk sync** complete store definitions (delete all + copy all)
- âœ… **Delete** selective or all definitions from a store
- âœ… **Dry-run** mode to preview changes before execution
- âœ… **Verbose logging** with optional log file output
- âœ… **Manifest-based** selective operations for granular control

## Installation

1. Clone this repository
2. Install dependencies: `npm install`
3. Set up your environment configuration (see Configuration section)
4. Link globally: `npm link` (optional)

## Configuration

Create a `.env` file in the project root with your Shopify private app credentials:

```env
# Store configurations
STAGING_STORE_URL=your-staging-store.myshopify.com
STAGING_ACCESS_TOKEN=shppa_xxxxxxxxxx

PRODUCTION_STORE_URL=your-production-store.myshopify.com
PRODUCTION_ACCESS_TOKEN=shppa_xxxxxxxxxx

# Add more stores as needed
DEVELOPMENT_STORE_URL=dev-store.myshopify.com
DEVELOPMENT_ACCESS_TOKEN=shppa_xxxxxxxxxx
```

## Usage

### NPM Scripts (Recommended)

For convenience, you can use npm scripts instead of the full `node src/cli.js` commands:

```bash
# Show main help
npm run help

# List definitions
npm run list -- --store staging --output definitions.md

# Copy definitions
npm run copy -- --from staging --to production --manifest manifest.md

# Bulk sync
npm run bulk -- --from staging --to production --dry-run

# Delete definitions
npm run delete -- --store staging --manifest cleanup.md
```

**Note:** Use `--` to pass arguments through npm to the underlying command.

### Direct CLI Usage

You can also use the CLI directly:

```bash
node src/cli.js --help
node src/cli.js list --store staging
# ... etc
```

### Global Options

All commands support these global options:

- `--dry-run` - Preview changes without executing them
- `--verbose` - Enable detailed logging output
- `--log <path>` - Save logs to a specific file
- `--config <path>` - Use a custom config file location

### Commands

#### 1. List Definitions

List and optionally export all metafield/metaobject definitions from a store:

```bash
# Using npm scripts (recommended)
npm run list -- --store staging
npm run list -- --store staging --output definitions.md
npm run list -- --store staging --verbose

# Direct CLI usage
node src/cli.js list --store staging
node src/cli.js list --store staging --output definitions.md
node src/cli.js list --store staging --verbose
```

#### 2. Copy Definitions

Copy specific definitions between stores using manifest files:

```bash
# Using npm scripts (recommended)
npm run copy -- --from staging --to production
npm run copy -- --from staging --to production --manifest manifest.md
npm run copy -- --from staging --to production --manifest manifest.md --dry-run

# Direct CLI usage
node src/cli.js copy --from staging --to production
node src/cli.js copy --from staging --to production --manifest manifest.md
node src/cli.js copy --from staging --to production --manifest manifest.md --dry-run
```

#### 3. Bulk Sync

Complete store synchronization (delete all + copy all):

```bash
# Using npm scripts (recommended)
npm run bulk -- --from staging --to production
npm run bulk -- --from staging --to production --dry-run
npm run bulk -- --from staging --to production --verbose

# Direct CLI usage
node src/cli.js bulk --from staging --to production
node src/cli.js bulk --from staging --to production --dry-run
node src/cli.js bulk --from staging --to production --verbose
```

#### 4. Delete Definitions

Delete definitions from a store:

```bash
# Using npm scripts (recommended)
npm run delete -- --store staging --manifest cleanup.md
npm run delete -- --store staging
npm run delete -- --store staging --manifest cleanup.md --dry-run

# Direct CLI usage
node src/cli.js delete --store staging --manifest cleanup.md
node src/cli.js delete --store staging
node src/cli.js delete --store staging --manifest cleanup.md --dry-run
```

## Unified Manifest Format

The tool uses a **unified manifest format** where the `list` command output is directly compatible with `copy` and `delete` command inputs. This eliminates format conversion steps and creates a seamless workflow.

### Generated by List Command

```markdown
# Store Definitions: staging

Generated: 2025-08-22T14:00:00.000Z

Found 25 metafield definitions and 3 metaobject definitions.

## Metafields

### product.specs.dimensions

- **Type:** single_line_text_field
- **Owner:** PRODUCT
- **Description:** Product dimensions
- **Access:** Admin=PUBLIC_READ_WRITE, Storefront=PUBLIC_READ

### product.specs.weight

- **Type:** number_decimal
- **Owner:** PRODUCT
- **Description:** Product weight in kg
- **Access:** Admin=PUBLIC_READ_WRITE, Storefront=PUBLIC_READ

### collection.seo.featured_image

- **Type:** file_reference
- **Owner:** COLLECTION
- **Description:** Featured image for collection SEO
- **Access:** Admin=PUBLIC_READ_WRITE, Storefront=PUBLIC_READ

## Metaobjects

### recipe

- **Name:** Recipe
- **Description:** Recipe information with ingredients and instructions
- **Fields:**
  - **title** (single_line_text_field) - Recipe title
  - **ingredients** (multi_line_text_field) - List of ingredients
  - **instructions** (rich_text_field) - Step by step instructions
- **Access:** Admin=PUBLIC_READ_WRITE, Storefront=PUBLIC_READ
- **Capabilities:** publishable, translatable

### author

- **Name:** Author Profile
- **Description:** Author information for blog posts
- **Fields:**
  - **name** (single_line_text_field) - Author name
  - **bio** (multi_line_text_field) - Author biography
- **Access:** Admin=PUBLIC_READ_WRITE, Storefront=PUBLIC_READ
- **Capabilities:** publishable
```

### Usage as Input Manifest

The above format can be used directly as input for `copy` and `delete` commands:

```bash
# Save list output to file
node src/cli.js list --store staging > definitions.md

# Edit the file to remove unwanted definitions
# (remove entire sections from ### header to next ### header)

# Use edited file directly with copy command
node src/cli.js copy --from staging --to production --manifest definitions.md
```

### Manifest Rules

- Use `## Metafields` and `## Metaobjects` as section headers
- Define metafields as `### namespace.key` (e.g., `### product.specs.weight`)
- Define metaobjects as `### type` (e.g., `### recipe`)
- All metadata lines are preserved and informational
- Only `###` headers are parsed for definitions - other content is ignored

## Examples

### Typical Workflow

1. **Review staging definitions:**

   ```bash
   node src/cli.js list --store staging --output staging-review.md
   ```

2. **Create a selective manifest (or edit the list output directly):**

   ```markdown
   # Production Deployment - Sprint 23

   Generated: 2025-08-22T14:00:00.000Z

   Found 25 metafield definitions and 3 metaobject definitions.

   ## Metafields

   ### product.specs.weight

   - **Type:** number_decimal
   - **Owner:** PRODUCT
   - **Description:** Product weight in kg

   ### product.specs.dimensions

   - **Type:** single_line_text_field
   - **Owner:** PRODUCT
   - **Description:** Product dimensions

   ## Metaobjects

   ### recipe

   - **Name:** Recipe
   - **Description:** Recipe information with ingredients and instructions
   - **Fields:**
     - **title** (single_line_text_field) - Recipe title
     - **ingredients** (multi_line_text_field) - List of ingredients
   - **Access:** Admin=PUBLIC_READ_WRITE, Storefront=PUBLIC_READ
   - **Capabilities:** publishable, translatable
   ```

3. **Preview the sync:**

   ```bash
   node src/cli.js copy --from staging --to production --manifest deploy-manifest.md --dry-run --verbose
   ```

4. **Execute the sync:**
   ```bash
   node src/cli.js copy --from staging --to production --manifest deploy-manifest.md --verbose
   ```

### Emergency Cleanup

```bash
# Delete problematic definitions
node src/cli.js delete --store production --manifest cleanup-manifest.md --dry-run

# Full store reset (dangerous!)
node src/cli.js delete --store staging --dry-run
```

### Complete Store Migration

```bash
# Full sync from staging to production
node src/cli.js bulk --from staging --to production --dry-run --verbose
```

## Error Handling

- The tool validates store configurations before execution
- Conflicting definitions are automatically detected and resolved
- Failed operations are logged with detailed error information
- Use `--dry-run` to preview changes and catch issues early
- Check log files for detailed error analysis

## API Requirements

This tool requires Shopify private apps with the following API permissions:

### Complete Scope List for All Operations

**Note**: Write access scopes are required for bulk operations, copy commands, and delete commands (mutations). Read scopes are sufficient for listing and viewing metafield definitions.

To handle all metafield and metaobject operations across all resource types, configure your private app with these access scopes:

- `read_products` + `write_products` (Product, Variant, Collection metafields)
- `read_customers` + `write_customers` (Customer, Company, Company Location metafields\*)
- `read_orders` + `write_orders` (Order metafields)
- `read_draft_orders` + `write_draft_orders` (Draft Order metafields)
- `read_locations` + `write_locations` (Location metafields)
- `read_markets` + `write_markets` (Market metafields)
- `read_content` + `write_content` (Page, Blog, Article metafields)
- `read_metaobjects_definitions` + `write_metaobjects_definitions` (Metaobject definitions)

\*Company and Company Location metafields require a **Shopify Plus** store.

### Specific Scopes by Resource Type

<details>
<summary>Click to expand detailed scope requirements</summary>

**Metaobjects:**

- `read_metaobjects_definitions`
- `write_metaobjects_definitions`

**Product metafields:**

- `read_products`
- `write_products`

**Variant metafields:**

- `read_products`
- `write_products`

**Collection metafields:**

- `read_products`
- `write_products`

**Customer metafields:**

- `read_customers`
- `write_customers`

**Order metafields:**

- `read_orders`
- `write_orders`

**Draft order metafields:**

- `read_draft_orders`
- `write_draft_orders`

**Company metafields (Shopify Plus only):**

- `read_customers`
- `write_customers`

**Company location metafields (Shopify Plus only):**

- `read_customers`
- `write_customers`

**Location metafields:**

- `read_locations`
- `write_locations`

**Page metafields:**

- `read_content`
- `write_content`

**Blog metafields:**

- `read_content`
- `write_content`

**Blog post metafields:**

- `read_content`
- `write_content`

**Market metafields:**

- `read_markets`
- `write_markets`

**Shop metafields:**

- **No additional scopes required** (all apps have access to shop-level data by default)

</details>

## Development

- **Language:** Node.js with ES modules
- **CLI Framework:** Commander.js
- **API Integration:** Custom GraphQL client for Shopify Admin API
- **Testing:** Run `npm test` for basic functionality tests

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Submit a pull request

## License

MIT License - see LICENSE file for details.
npm install

````
3. Copy environment template:

```bash
cp .env.example .env
````

4. Configure your Shopify store tokens in `.env`:
   ```env
   STAGING_STORE_TOKEN=shpat_your_staging_token_here
   PRODUCTION_STORE_TOKEN=shpat_your_production_token_here
   ```

## Setup Shopify Private Apps

For each store, create a private app with the adequate scopes (see list above)

## Usage

### List Definitions

List all metafield and metaobject definitions from a store:

```bash
node src/cli.js list --store staging
```

Export to a file:

```bash
node src/cli.js list --store staging --output definitions.md
```

### Bulk Sync

Delete all definitions from target and copy all from source:

```bash
node src/cli.js bulk --from staging --to production
```

Preview changes without executing:

```bash
node src/cli.js bulk --from staging --to production --dry-run
```

### Global Options

- `--dry-run`: Preview changes without executing
- `--verbose`: Detailed logging output
- `--log <path>`: Save logs to file

## Commands

| Command  | Description                                                             | Status      |
| -------- | ----------------------------------------------------------------------- | ----------- |
| `list`   | List all metafield and metaobject definitions from a store              | âœ… Complete |
| `copy`   | Copy selective definitions between stores using manifest files          | âœ… Complete |
| `bulk`   | Delete all definitions from target store and copy all from source store | âœ… Complete |
| `delete` | Delete selective definitions from a store using manifest files          | âœ… Complete |

## Development Status

âœ… **Completed:**

- âœ… Basic CLI structure with Commander.js framework
- âœ… Environment configuration and store management
- âœ… Shopify GraphQL Admin API client (2025-01)
- âœ… **List command** with unified manifest-compatible markdown export
- âœ… **Copy command** with manifest support for selective operations
- âœ… **Bulk sync command** with complete store replication
- âœ… **Delete command** with manifest support for selective cleanup
- âœ… Comprehensive logging system with verbose/dry-run modes
- âœ… **Unified manifest format** - list output directly usable as copy/delete input
- âœ… **Metafield support** for all owner types (Product, Customer, Order, etc.)
- âœ… **Metaobject support** with definition and entry management
- âœ… **Access level mapping** and compatibility handling
- âœ… **Error handling** with detailed GraphQL error reporting
- âœ… **API scope documentation** with complete requirements
- âœ… **End-to-end workflow** testing and validation

ðŸŽ¯ **Current Status: Production Ready**

All core functionality is implemented and tested. The tool supports:

- Complete metafield/metaobject definition management
- Selective operations via manifest files
- Staging â†’ Production deployment workflows
- Safe dry-run previews and comprehensive logging

ðŸ“‹ **Future Enhancements (Optional):**

- ðŸ”„ Rate limiting for large operations
- ðŸ“Š Progress bars for bulk operations
- ðŸ”” Interactive confirmation prompts
- ðŸ“ˆ Operation statistics and reporting
- ðŸ”§ Configuration validation utilities
- ðŸ“¦ npm package publication

## Project Structure

```
meta-sync/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ cli.js              # Main CLI entry point
â”‚   â”œâ”€â”€ commands/           # Command implementations
â”‚   â”‚   â”œâ”€â”€ bulk.js
â”‚   â”‚   â”œâ”€â”€ list.js
â”‚   â”‚   â”œâ”€â”€ copy.js
â”‚   â”‚   â””â”€â”€ delete.js
â”‚   â”œâ”€â”€ shopify/           # Shopify API client
â”‚   â”‚   â””â”€â”€ client.js
â”‚   â”œâ”€â”€ managers/          # Business logic managers
â”‚   â””â”€â”€ utils/             # Utilities
â”‚       â”œâ”€â”€ config.js      # Configuration management
â”‚       â””â”€â”€ logger.js      # Logging utilities
â”œâ”€â”€ .env.example           # Environment template
â””â”€â”€ package.json
```

## Technical Details

### Delete Operation

The `delete` command automatically handles associated metafield values:

- **Automatic Cleanup**: When deleting metafield definitions, the tool uses Shopify's `deleteAllAssociatedMetafields: true` parameter
- **No Manual Intervention**: You don't need to manually delete metafield values before deleting definitions
- **Complete Removal**: All metafield values across all resources (products, orders, customers, etc.) are automatically removed
- **Async Operation**: Shopify handles the value deletion asynchronously after the definition is removed

## Contributing

This is a personal project, but feel free to suggest improvements!
